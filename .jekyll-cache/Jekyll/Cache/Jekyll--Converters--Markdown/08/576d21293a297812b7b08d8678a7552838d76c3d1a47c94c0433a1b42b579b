I"û<h1 id="autoscaling-applications-using-custom-metrics-on-openshift-container-platform-311-with-jboss-eap-or-wildfly">Autoscaling applications using custom metrics on OpenShift Container Platform 3.11 with JBoss EAP or Wildfly</h1>

<p>Red Hat OpenShift Container Platform 3.11 (OCP) ì€ ê¸°ë³¸ì ìœ¼ë¡œ CPUì— ëŒ€í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ìë™ í™•ì¥ì„ ì§€ì›í•©ë‹ˆë‹¤. ì¶”ê°€ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">apis/autoscaling/v2beta1</code>ë¥¼ í™œì„±í™”í•˜ì—¬ <a href="#2-Memory-based-HPA">Memoryì˜ ë©”íŠ¸ë¦­ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ê¸°ëŠ¥</a>ë„ ì§€ì› í•©ë‹ˆë‹¤. CPUë‚˜ Memoryì˜ ê²½ìš° ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì¢…ì†ë˜ì§€ ì•Šì€ ê¸°ë³¸ì ì¸ ë©”íŠ¸ë¦­ì´ë‚˜, ë•Œë¡œëŠ” ì¶”ê°€ì ì¸ ë©”íŠ¸ë¦­ ìš”ì†Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í™•ì¥í•  í•„ìš”ì„±ì´ ìˆìŠµë‹ˆë‹¤.</p>

<p>Prometheus Adaptorë¥¼ ì‚¬ìš©í•˜ë©´ ê¸°ë³¸ ë©”íŠ¸ë¦­ ì™¸ì—ë„ ì‚¬ìš©ìê°€ ì§€ì •í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë©”íŠ¸ë¦­ì„ ê¸°ë°˜ìœ¼ë¡œ ìë™í™•ì¥í•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<blockquote>
  <p>Prometheus AdaptorëŠ” OCP 4.1 ë¶€í„° ì—ì„œ Tech Preview ëŒ€ìƒì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ëŠ¥ì´ ì™„ì „í•´ì§€ë©´ ì •ì‹ ì§€ì›ìƒíƒœë¡œ ë³€ê²½ ë  ê²ƒì…ë‹ˆë‹¤.</p>
</blockquote>

<p>Prometheus AdaptorëŠ” <code class="language-plaintext highlighter-rouge">custom.metrics.k8s.io</code> APIë¥¼ êµ¬í˜„í•˜ì—¬ Prometheusì— ì—°ê²°í•©ë‹ˆë‹¤. Prometheusì—ì„œ ìˆ˜ì§‘ë˜ëŠ” ë©”íŠ¸ë¦­ ê¸°ë°˜ìœ¼ë¡œ Horizontal Pod Autoscaler (HPA)ê°€ ì¿¼ë¦¬í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”íŠ¸ë¦­ì„ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì´ê¸€ì€ ë‹¤ìŒì˜ ê³¼ì •ì„ ì•ˆë‚´ í•©ë‹ˆë‹¤.</p>

<ol>
  <li>JBoss EAP ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒ˜í”Œê³¼ JMX exporter</li>
  <li>OCP 3.11ì— Operatorë¥¼ ì‚¬ìš©í•˜ì—¬ Prometheusë¥¼ ë°°í¬</li>
  <li>Prometheus Adapter ì„¤ì •</li>
</ol>

<p>ê° ë‚´ìš©ì˜ ìƒì„¸ ì •ë³´ëŠ” <a href="#1-ì°¸ê³ -ìë£Œ"><strong>ì°¸ê³  ìë£Œ</strong></a>ì˜ ë‚´ìš©ì´ ë„ì›€ì´ ë©ë‹ˆë‹¤.</p>

<h2 id="ì¤€ë¹„-ì‚¬í•­-ë°-ì¡°ê±´">ì¤€ë¹„ ì‚¬í•­ ë° ì¡°ê±´</h2>

<ul>
  <li>OpenShift 3.11 í´ëŸ¬ìŠ¤í„°</li>
  <li>ë¦¬ì†ŒìŠ¤ ìƒì„± ê¶Œí•œì´ ìˆëŠ” <code class="language-plaintext highlighter-rouge">cluster-admin</code> ê¶Œí•œì´ ìˆëŠ” ê³„ì •</li>
  <li>ë¦¬ì†ŒìŠ¤ ìƒì„± ë°©ë²•ì„ í¬í•¨í•œ OpenShift ê¸°ë³¸ ì§€ì‹</li>
  <li>Kubernetes ì— ëŒ€í•œ ê¸°ë³¸ ì§€ì‹</li>
</ul>

<h2 id="openshift-311-operator-í™˜ê²½-êµ¬ì„±">OpenShift 3.11 Operator í™˜ê²½ êµ¬ì„±</h2>

<p>OpenShift Container Platform 3.11 í™˜ê²½ì— Operatorë¥¼ í™œì„±í™” í•˜ê¸° ìœ„í•œ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ê¸°ì¡´ì— ì´ë¯¸ Operator êµ¬ì„±ì„ ì„¤ì¹˜ í•œê²½ìš° í•´ë‹¹ ê³¼ì •ì„ ë„˜ì–´ê°‘ë‹ˆë‹¤.</p>

<ul>
  <li>
    <p>OCP 3.11 ì„¤ì¹˜ë¥¼ ì§„í–‰í•œ hosts íŒŒì¼ì˜ <code class="language-plaintext highlighter-rouge">[OSEv3:vars]</code>í•­ëª©ì— ë‹¤ìŒì„ ì¶”ê°€</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">registry.connect.redhat.com</code>ì— ì ‘ì†í•˜ê¸° ìœ„í•œ ê³„ì • ì •ë³´ê°€ í•„ìš”</p>
      </li>
      <li>
        <p><a href="#3-Registry-account">ê³„ì •ì„ ì™¸ë¶€ë¡œ ë…¸ì¶œì‹œí‚¤ì§€ ì•Šê¸° ìœ„í•œ ë°©ë²• ì°¸ê³ </a></p>
      </li>
    </ul>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">openshift_additional_registry_credentials=[{'host':'registry.connect.redhat.com','user':'&lt;your_user_name&gt;','password':'&lt;your_password&gt;','test_image':'mongodb/enterprise-operator:0.3.2'}]</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>registry ì¶”ê°€ë¥¼ ìœ„í•œ Ansible playbook ì‹¤í–‰</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> /usr/share/ansible/openshift-ansible
<span class="nv">$ </span>ansible-playbook <span class="nt">-i</span> &lt;inventory_file&gt; playbooks/updates/registry_auth.yml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Operator framework ì„¤ì¹˜ë¥¼ ìœ„í•œ Ansible playbook ì‹¤í–‰</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> /usr/share/ansible/openshift-ansible
<span class="nv">$ </span>ansible-playbook <span class="nt">-i</span> &lt;inventory_file&gt; playbooks/olm/config.yml
</code></pre></div>    </div>
  </li>
</ul>

<p>Operator frameworkê°€ ì„¤ì¹˜ë˜ë©´ Cluster Console ì—ì„œ ì¢Œì¸¡ ë©”ë‰´ì— ì¶”ê°€ëœ <code class="language-plaintext highlighter-rouge">Operators</code> ë¥¼ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="http://raw.githubusercontent.com/Great-Stone/share/master/assets/img/OpenShift_custom_metric_with_JBoss/operator.png" alt="image-20200129150607944" /></p>

<h2 id="ì• í”Œë¦¬ì¼€ì´ì…˜-ìƒ˜í”Œê³¼-jmx-exporter">ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒ˜í”Œê³¼ JMX exporter</h2>

<p>JMX exportëŠ” Prometheusë¡œ Java ê¸°ë°˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ìˆ˜ì§‘ ê°€ëŠ¥í•œ JMXì˜ mBeanì„ ì „ë‹¬ê°€ëŠ¥í•˜ë„ë¡ í•˜ëŠ” ìˆ˜ì§‘ê¸° ì…ë‹ˆë‹¤. Java ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ í•¨ê»˜ ì‹¤í–‰ë˜ë©° HTTP ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë…¸ì¶œì‹œì¼œ JVMì˜ ë©”íŠ¸ë¦­ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>

<p>JMX exportë¥¼ javaagent ë°©ì‹ìœ¼ë¡œ ì ìš©í•˜ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë³„ë„ì˜ ìˆ˜ì •ì´ë‚˜ ì¶”ê°€ ì½”ë”© ì—†ì´ JMXë¡œ ìˆ˜ì§‘ë˜ëŠ” mBean ê°’ë“¤ì„ ë…¸ì¶œ ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ë‹¤ìŒì˜ ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê¸°ë°˜ìœ¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.</p>

<p>https://github.com/Great-Stone/webapp</p>

<h2 id="jboss-eap-ë°°í¬">JBoss EAP ë°°í¬</h2>

<p>ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>webapp
â”œ configuration
â”‚	â”œ standalone-openshift.xml
â”‚	â”” jmx_exporter_conf.yaml
â”œ modules
â”‚	â”” jmx_prometheus_javaagent-0.12.0.jar
â”” ROOT.war
</code></pre></div></div>

<p>Red Hatì—ì„œ ì œê³µë˜ëŠ” JBoss EAPëŠ” S2I ë¹Œë“œ ë°°í¬ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ ì†ŒìŠ¤ ë˜ëŠ” ë°”ì´ë„ˆë¦¬ë¥¼ ë³„ë„ì˜ ì´ë¯¸ì§€ ë¹Œë“œ(e.g. Docker build) ì—†ì´ ë°”ë¡œ OpenShift ìƒì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¡œ ë¹Œë“œí•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>

<ul>
  <li>root ë˜ëŠ” deployment ë””ë ‰í† ë¦¬ ë‚´ì˜ ë°”ì´ë„ˆë¦¬ëŠ” JBoss EAP ì˜ deployments ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬ë˜ì–´ ë¹Œë“œ ë©ë‹ˆë‹¤.</li>
  <li>configuration ë””ë ‰í† ë¦¬ ë‚´ì˜ íŒŒì¼ì€ JBoss EAP ì˜ configuration ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬ë˜ì–´ ë¹Œë“œ ë©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ JBoss EAPì˜ ê¸°ë³¸ standalone.xmlì€ í•´ë‹¹ S2Iì´ë¯¸ì§€ ë‚´ì—ì„œëŠ” standalone-openshift.xmlë¡œ ëŒ€ì²´ë˜ì—ˆìŠµë‹ˆë‹¤. configuration ë””ë ‰í† ë¦¬ì— í•´ë‹¹ xml íŒŒì¼ì„ ìœ„ì¹˜ì‹œí‚¤ë©´ ì‚¬ìš©ì ì •ì˜ xmlì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ê°™ì€ íŠ¹ì§•ì„ ì´ìš©í•˜ì—¬ jmx-exporterì—ì„œ ì½ì–´ë“¤ì¼ yaml íŒŒì¼ì¸ <code class="language-plaintext highlighter-rouge">jmx_exporter_conf.yaml</code> íŒŒì¼ì„ í•´ë‹¹ ë””ë ‰í† ë¦¬ì— ìœ„ì¹˜ì‹œì¼œ S2I ë¹Œë“œì‹œ ë¹Œë“œ ì´ë¯¸ì§€ ë‚´ì— ë³µì‚¬ë˜ë„ë¡ í•©ë‹ˆë‹¤.</li>
  <li>modules ë””ë ‰í† ë¦¬ëŠ” JBossì—ì„œ ì‚¬ìš©í•  module ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€ í•  ìˆ˜ ìˆë„ë¡ ë³µì‚¬í•´ì£¼ëŠ” ìœ„ì¹˜ ì…ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">jmx_prometheus_javaagent-0.12.0.jar</code> ë¥¼ ë¹Œë“œ ì‹œ ì´ë¯¸ì§€ ë‚´ë¶€ì— ë³µì‚¬ í•  ìˆ˜ ìˆë„ë¡ í•´ë‹¹ ë””ë ‰í† ë¦¬ë‚´ì— ìœ„ì¹˜ì‹œí‚µë‹ˆë‹¤.</li>
</ul>

<h3 id="jmx_exporter_confyaml">jmx_exporter_conf.yaml</h3>

<p><code class="language-plaintext highlighter-rouge">jmx_exporter_conf.yaml</code> ì—ì„œ ì˜ˆì‹œë¡œ ì„¤ì •í•œ ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">startDelaySeconds</span><span class="pi">:</span> <span class="m">30</span>
<span class="na">lowercaseOutputName</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">lowercaseOutputLabelNames</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">whitelistObjectNames</span><span class="pi">:</span> 
  <span class="pi">-</span> <span class="s2">"</span><span class="s">jboss.as:subsystem=request-controller"</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">pattern</span><span class="pi">:</span> <span class="s2">"</span><span class="s">^jboss.as&lt;subsystem=request-controller&gt;&lt;&gt;(active_.+|max_.+):</span><span class="nv"> </span><span class="s">(.*)"</span>
    <span class="na">attrNameSnakeCase</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">jboss_$1</span>
    <span class="na">help</span><span class="pi">:</span> <span class="s2">"</span><span class="s">jboss</span><span class="nv"> </span><span class="s">Request</span><span class="nv"> </span><span class="s">Controller</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">$1"</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">namespace</span><span class="pi">:</span> <span class="s1">'</span><span class="s">my-eap-project'</span>
      <span class="na">pod</span><span class="pi">:</span> <span class="s1">'</span><span class="s">sample-eap'</span>
      <span class="na">service</span><span class="pi">:</span> <span class="s1">'</span><span class="s">sample-eap'</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>whitelistObjectNames</td>
      <td><code class="language-plaintext highlighter-rouge">"jboss.as:subsystem=request-controller"</code>ì˜ ê²½ìš° mBean ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤. jconsoleì´ë‚˜ jvisualVM íˆ´ì„ ì‚¬ìš©í•˜ì—¬ í™•ì¸ ê°€ëŠ¥í•˜ë©°, í•„ìš”ì‹œ ë¡œì»¬ì´ë‚˜ ë¦¬ëª¨íŠ¸ì˜ JBoss EAP / Wildflyì—ì„œ ì›í•˜ëŠ” ê°’ ì •ì˜ ê°€ëŠ¥</td>
    </tr>
    <tr>
      <td>pattern</td>
      <td>mBean ObjectNameì˜ Attribute ê°’ì˜ íŒ¨í„´ì„ ì •ì˜ í•©ë‹ˆë‹¤. ë‹¨ì¼ ë˜ëŠ” ë³µìˆ˜ì˜ Nameì„ ì •ì˜ ê°€ëŠ¥</td>
    </tr>
    <tr>
      <td>name</td>
      <td>jmx_exporter ì—ì„œ í‘œê¸°í•  ì´ë¦„ ê·œì¹™ì„ ì„¤ì •</td>
    </tr>
    <tr>
      <td>labels</td>
      <td>OpenShift í™˜ê²½ì—ì„œ ì‹ë³„í•  ìˆ˜ ìˆëŠ” labelì„ ì¶”ê°€í•©ë‹ˆë‹¤. namespace, pod, service ëŠ” ê¸°ë³¸ JMX exporterë¡œëŠ” ìˆ˜ì§‘ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ í•´ë‹¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë°°í¬ë  OpenShift í™˜ê²½ì— ë§ì¶° ì„¤ì •</td>
    </tr>
  </tbody>
</table>

<p>ê¸°íƒ€ ìƒì„¸ ì˜µì…˜ì€ ë‹¤ìŒì˜ urlì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<p>https://github.com/prometheus/jmx_exporter#configuration</p>

<h3 id="jboss-eap--wildfly-ë°°í¬">JBoss EAP / Wildfly ë°°í¬</h3>

<ul>
  <li>OpenShift Application Consoleì—ì„œ ì‘ì—… ì§„í–‰</li>
  <li>ë°°í¬ í•  í”„ë¡œì íŠ¸ë¥¼ ìƒì„± (e.g. my-eap-project)</li>
  <li>í•´ë‹¹ í”„ë¡œì íŠ¸ë¥¼ ì„ íƒ í›„ ì¢Œì¸¡ ë©”ë‰´ì˜ Catalogë¥¼ ì„ íƒ</li>
  <li><code class="language-plaintext highlighter-rouge">JBoss EAP 7.2</code>ë¥¼ ì„ íƒ
    <ul>
      <li>Information <code class="language-plaintext highlighter-rouge">Next&gt;</code> í´ë¦­</li>
      <li>Configuration (ì•ì„œ <code class="language-plaintext highlighter-rouge">jmx_exporter_conf.yaml</code>ì˜ ë ˆì´ë¸” ì„¤ì • ì°¸ê³ )
        <ul>
          <li>Application Name: sample-eap</li>
          <li>Git Repository URL: https://github.com/Great-Stone/webapp.git</li>
          <li>Git Reference: master</li>
          <li>Context Directory: (Blank)</li>
          <li>Labels
            <ul>
              <li>app : sample-eap</li>
            </ul>
          </li>
          <li><code class="language-plaintext highlighter-rouge">Create</code> ë²„íŠ¼ í´ë¦­</li>
        </ul>
      </li>
      <li>Results
        <ul>
          <li>ìƒì„± í™•ì¸ í›„ <code class="language-plaintext highlighter-rouge">Close</code> ë²„íŠ¼ í´ë¦­</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>ì¢Œì¸¡ ë©”ë‰´ì—ì„œ  <code class="language-plaintext highlighter-rouge">Builds</code>í´ë¦­ í›„ ìƒì„±í•œ <code class="language-plaintext highlighter-rouge">sample-eap</code> í™•ì¸</p>
  </li>
  <li>
    <p>ì¢Œì¸¡ ë©”ë‰´ì—ì„œ <code class="language-plaintext highlighter-rouge">Applications</code> &gt; <code class="language-plaintext highlighter-rouge">Deployments</code> í´ë¦­ í›„ ìƒì„±ëœ Deployment Config  <code class="language-plaintext highlighter-rouge">sample-eap</code>  í´ë¦­</p>

    <ul>
      <li>
        <p>Environment íƒ­ì„ ì„ íƒí•˜ê³  ë‹¤ìŒì„ ì¶”ê°€í•˜ê³  í•˜ë‹¨ <code class="language-plaintext highlighter-rouge">Save</code> ë²„íŠ¼ í´ë¦­</p>

        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>JAVA_OPTS_APPEND</td>
              <td>-javaagent:/opt/eap/modules/jmx_prometheus_javaagent-0.12.0.jar=58080:/opt/eap/standalone/configuration/jmx_exporter_conf.yaml</td>
            </tr>
          </tbody>
        </table>

        <ul>
          <li>
            <p><code class="language-plaintext highlighter-rouge">JAVA_OPTS_APPEND</code> í™˜ê²½ ë³€ìˆ˜ì— ê°’ì„ ê¸°ì…í•˜ë©´ í•´ë‹¹ JBoss EAP 7.2 S2I ë¹Œë“œ ì‹œ ì‹¤í–‰ë˜ëŠ” ì„œë²„ì˜ Java Option ê°’ ë’¤ì— í•´ë‹¹ ê°’ì´ ì¶”ê°€ë¨</p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">javaagent</code>ë¡œ ë¹Œë“œì‹œ í•´ë‹¹ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë‚´ë¶€ë¡œ ë³µì‚¬ëœ <code class="language-plaintext highlighter-rouge">modules</code> ë””ë ‰í† ë¦¬ì˜ <code class="language-plaintext highlighter-rouge">jmx_prometheus_javaagent-0.12.0.jar</code>ë¥¼ ì§€ì •í•˜ê³  <code class="language-plaintext highlighter-rouge">=58080</code>ì€ ì—”ë“œí¬ì¸íŠ¸ í¬íŠ¸ë¥¼ ì •ì˜</p>
          </li>
          <li>
            <p>ì¶”ê°€ë¡œ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë‚´ë¶€ë¡œ ë³µì‚¬ëœ <code class="language-plaintext highlighter-rouge">configuration</code> ë””ë ‰í† ë¦¬ì˜ ì„¤ì • íŒŒì¼ì¸ <code class="language-plaintext highlighter-rouge">jmx_exporter_conf.yaml</code>ì„ ì •ì˜</p>
          </li>
        </ul>
      </li>
      <li>
        <p>ìš°ì¸¡ ìƒë‹¨ì˜ <code class="language-plaintext highlighter-rouge">Actions</code> &gt; <code class="language-plaintext highlighter-rouge">Edit YAML</code>ì„ í´ë¦­í•˜ì—¬ <code class="language-plaintext highlighter-rouge">spec &gt; template &gt; metadata &gt; annotations</code>ì— <code class="language-plaintext highlighter-rouge">prometheus.io/scrape: 'true'</code>ë¥¼ ì¶”ê°€í•˜ê³  í•˜ë‹¨ì˜ <code class="language-plaintext highlighter-rouge">Save</code> ë²„íŠ¼ í´ë¦­</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps.openshift.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DeploymentConfig</span>
<span class="nn">...</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="s">prometheus.io/scrape</span><span class="pi">:</span> <span class="s1">'</span><span class="s">true'</span>
      <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
      <span class="s">...</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>ì¢Œì¸¡ ë©”ë‰´ì—ì„œ <code class="language-plaintext highlighter-rouge">Applications</code> &gt; <code class="language-plaintext highlighter-rouge">Services</code> í´ë¦­ í›„ ìƒì„±ëœ Service  <code class="language-plaintext highlighter-rouge">sample-eap</code>  í´ë¦­</p>

    <ul>
      <li>
        <p>ìš°ì¸¡ ìƒë‹¨ì˜ <code class="language-plaintext highlighter-rouge">Actions</code> &gt; <code class="language-plaintext highlighter-rouge">Edit YAML</code>ì„ í´ë¦­í•˜ì—¬ <code class="language-plaintext highlighter-rouge">prometheus.io/scrape: "true"</code> í•­ëª©ê³¼ exportë¥¼ ìœ„í•œ portë¥¼ ì¶”ê°€í•˜ê³  í•˜ë‹¨ <code class="language-plaintext highlighter-rouge">Save</code> ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤. portëŠ” eapë¥¼ ìœ„í•œ ì„œë¹„ìŠ¤ë¥¼ ìœ„í•œ portì™€ exporterë¥¼ ìœ„í•œ port ë‘ê°œê°€ í•„ìš”í•¨</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s">The web server's http port.</span>
    <span class="s">prometheus.io/scrape</span><span class="pi">:</span> <span class="s1">'</span><span class="s">true'</span>
  <span class="s">...</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">eap</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
      <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">exporter</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">58080</span>
      <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">58080</span>
  <span class="s">...</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>Serviceì— ìƒˆë¡œìš´ í¬íŠ¸ë¥¼ ì¶”ê°€í•˜ë©´ ê¸°ì¡´ routeë¥¼ ì˜¬ë°”ë¥¸ í¬íŠ¸ì— ì—°ê²°í•˜ê³ , exporterì˜ ë°ì´í„° í™•ì¸ì„ ìœ„í•œ ìƒˆë¡œìš´ routeë¥¼ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì¶”ê°€</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ì¢Œì¸¡ ë©”ë‰´ì—ì„œ <code class="language-plaintext highlighter-rouge">Applications</code> &gt; <code class="language-plaintext highlighter-rouge">Routes</code> í´ë¦­ í›„ ìƒì„±ëœ route <code class="language-plaintext highlighter-rouge">sample-eap</code>  í´ë¦­</p>

    <ul>
      <li>ìš°ì¸¡ ìƒë‹¨ì˜ <code class="language-plaintext highlighter-rouge">Actions</code> &gt; <code class="language-plaintext highlighter-rouge">Edit</code>ì„ í´ë¦­ í•˜ê³  <code class="language-plaintext highlighter-rouge">Target Port</code>ë¥¼ <code class="language-plaintext highlighter-rouge">8080â†’8080(TCP)</code>ì„ì„ í™•ì¸ í›„ í•˜ë‹¨ <code class="language-plaintext highlighter-rouge">Save</code>ë²„íŠ¼ í´ë¦­</li>
      <li>ë‹¤ì‹œ Routes ëª©ë¡ í™”ë©´ìœ¼ë¡œ ì´ë™í•˜ì—¬ ìš°ì¸¡ ìƒë‹¨ì˜ <code class="language-plaintext highlighter-rouge">Create Route</code> í´ë¦­í•˜ì—¬ ë‹¤ìŒì„ ì„¤ì •í•˜ê³  í•˜ë‹¨ <code class="language-plaintext highlighter-rouge">Save</code>ë²„íŠ¼ í´ë¦­
        <ul>
          <li>Name: sample-eap-exporter</li>
          <li>Target Port: 58080â†’58080(TCP)</li>
          <li>Security(ì„ íƒì‚¬í•­)
            <ul>
              <li>Secure route: Checked</li>
              <li>TLS Termination: Edge</li>
              <li>Insecure Traffic: None</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>JMX exporterê°€ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸ì„ ìœ„í•´ ì‚¬ë¡œ ìƒì„±í•œ <code class="language-plaintext highlighter-rouge">sample-eap-exporter</code>ì˜ Hostnameì„ í´ë¦­í•˜ì—¬ ì •ë³´ í™•ì¸</p>

    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="err">#</span> <span class="nx">HELP</span> <span class="nx">jboss_active_requests</span> <span class="nx">jboss</span> <span class="nx">Request</span> <span class="nx">Controller</span> <span class="p">:</span> <span class="nx">active_requests</span>
<span class="err">#</span> <span class="nx">TYPE</span> <span class="nx">jboss_active_requests</span> <span class="nx">untyped</span>
<span class="nx">jboss_active_requests</span><span class="p">{</span><span class="nx">namespace</span><span class="o">=</span><span class="dl">"</span><span class="s2">my-eap-project</span><span class="dl">"</span><span class="p">,</span><span class="nx">pod</span><span class="o">=</span><span class="dl">"</span><span class="s2">sample-eap</span><span class="dl">"</span><span class="p">,</span><span class="nx">service</span><span class="o">=</span><span class="dl">"</span><span class="s2">sample-eap</span><span class="dl">"</span><span class="p">,}</span> <span class="mf">0.0</span>
<span class="err">#</span> <span class="nx">HELP</span> <span class="nx">jboss_max_requests</span> <span class="nx">jboss</span> <span class="nx">Request</span> <span class="nx">Controller</span> <span class="p">:</span> <span class="nx">max_requests</span>
<span class="err">#</span> <span class="nx">TYPE</span> <span class="nx">jboss_max_requests</span> <span class="nx">untyped</span>
<span class="nx">jboss_max_requests</span><span class="p">{</span><span class="nx">namespace</span><span class="o">=</span><span class="dl">"</span><span class="s2">my-eap-project</span><span class="dl">"</span><span class="p">,</span><span class="nx">pod</span><span class="o">=</span><span class="dl">"</span><span class="s2">sample-eap</span><span class="dl">"</span><span class="p">,</span><span class="nx">service</span><span class="o">=</span><span class="dl">"</span><span class="s2">sample-eap</span><span class="dl">"</span><span class="p">,}</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="p">...</span>
</code></pre></div>    </div>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">jmx_exporter_conf.yaml</code>ì—ì„œ ì •ì˜í•œ JMX ë‚´ìš©ì´ í‘œê¸°ë˜ëŠ”ì§€ í™•ì¸</li>
      <li>ì˜ˆì œì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">jboss_</code>ë¥¼ prefixë¡œ ì •ì˜í•˜ì˜€ê³  <code class="language-plaintext highlighter-rouge">active_*</code>, <code class="language-plaintext highlighter-rouge">max_*</code> í•­ëª©ì˜ Attribute ë°ì´í„°ë¥¼ í‘œê¸°</li>
      <li>ë°ì´í„°ì˜ labelì¸ namespace, pod, serviceê°€ í‘œê¸°ë˜ëŠ”ì§€ í™•ì¸</li>
    </ul>
  </li>
</ul>

<h2 id="setting-up-prometheus">Setting up Prometheus</h2>

<p>Operator frameworkë¥¼ í™œìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ëª¨ë‹ˆí„°ë§ í•˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê° yamlë¡œ ì‘ì„±ëœ ì„¤ì •ì€ CLI ë˜ëŠ” OpenShift Console ìƒì—ì„œ ì§„í–‰ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ìš©í•˜ëŠ” ê° ë°©ë²•ì€ <a href="#4-OpenShiftì—-ë¦¬ì†ŒìŠ¤-ë°°í¬">OpenShiftì— ë¦¬ì†ŒìŠ¤ ë°°í¬</a> ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.</p>

<p>Prometheus êµ¬ì„±ìš”ì†Œë¥¼ ë°°í¬í•˜ê¸° ìœ„í•´ í”„ë¡œì íŠ¸ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” <code class="language-plaintext highlighter-rouge">custom-metric</code> í”„ë¡œì íŠ¸ì—ì„œ ì§„í–‰í•©ë‹ˆë‹¤.</p>

<p>#### 1) Operator subscription ìƒì„±</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>oc create <span class="nt">-f</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  generateName: prometheus-
  namespace: custom-metric
spec:
  source: rh-operators
  name: prometheus
  startingCSV: prometheusoperator.0.22.2
  channel: preview
</span><span class="no">EOF
</span></code></pre></div></div>

<h4 id="2-service-monitor-ìƒì„±">2) Service monitor ìƒì„±</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc apply <span class="nt">-f</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: sample-app
  labels:
    app: sample-app
  namespace: prometheus-metric
spec:
  selector:
    matchLabels:
      app: sample-app
    namespaceSelector:
      matchNames:
        - my-eap-project
  endpoints:
    - port: exporter
</span><span class="no">EOF
</span></code></pre></div></div>

<h4 id="3-prometheus-operatorê°€-ì œê³µí•˜ëŠ”-ì‚¬ìš©ì-ì •ì˜-ì˜¤ë¸Œì íŠ¸-ìƒì„±">3) Prometheus Operatorê°€ ì œê³µí•˜ëŠ” ì‚¬ìš©ì ì •ì˜ ì˜¤ë¸Œì íŠ¸ ìƒì„±</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc apply <span class="nt">-f</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: example
  labels:
    prometheus: k8s
  namespace: prometheus-metric
spec:
  replicas: 1
  version: v2.3.2
  serviceAccountName: prometheus-k8s
  securityContext: {}
  serviceMonitorSelector:
    matchLabels:
      app: sample-app
</span><span class="no">EOF
</span></code></pre></div></div>

<h4 id="4-prometheus-adapterê°€-ì¿¼ë¦¬-í• -ìˆ˜-ìˆë„ë¡-prometheus-podë¥¼-ì„œë¹„ìŠ¤ë¥¼-ì‘ì„±">4) Prometheus Adapterê°€ ì¿¼ë¦¬ í•  ìˆ˜ ìˆë„ë¡ Prometheus Podë¥¼ ì„œë¹„ìŠ¤ë¥¼ ì‘ì„±</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>oc apply <span class="nt">-f</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: Service
metadata:
  name: prometheus
spec:
  ports:
  - name: web
    port: 9090
    protocol: TCP
    targetPort: web
  selector:
    prometheus: example
</span><span class="no">EOF
</span></code></pre></div></div>

<h2 id="prometheus-adapter-setup">Prometheus Adapter setup</h2>

<p>Prometheusê°€ ì„¤ì •ëœ ìƒíƒœì—ì„œ ë‹¤ìŒ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì„¤ì •ì„ ì¶”ê°€í•˜ì—¬ Prometheus Adopter ì„¤ì •í•©ë‹ˆë‹¤. RBAC ì ‘ê·¼ì œì–´, Adapter êµ¬ì„±, API í™•ì¥, Deployment í•­ëª©ë“¤ì´ í¬í•¨ë˜ì–´ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">custom-metrics-apiserver</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">prometheus-metric</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">custom-metrics-server-resources</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">custom.metrics.k8s.io</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">*"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">*"</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">custom-metrics-resource-reader</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">namespaces</span>
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="pi">-</span> <span class="s">services</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="s">list</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">custom-metrics:system:auth-delegator</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:auth-delegator</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">custom-metrics-apiserver</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">prometheus-metric</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">RoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">custom-metrics-auth-reader</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">extension-apiserver-authentication-reader</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">custom-metrics-apiserver</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">prometheus-metric</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">custom-metrics-resource-reader</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">custom-metrics-resource-reader</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">custom-metrics-apiserver</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">prometheus-metric</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">hpa-controller-custom-metrics</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">custom-metrics-server-resources</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">horizontal-pod-autoscaler</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">prometheus-metric</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">adapter-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">prometheus-metric</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="s">config.yaml</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">rules:</span>
    <span class="s">- seriesQuery: '{__name__="jboss_active_requests",namespace!="",pod!=""}'</span>
      <span class="s">resources:</span>
        <span class="s">overrides:</span>
          <span class="s">namespace: {resource: "namespace"}</span>
          <span class="s">pod: {resource: "pod"}</span>
          <span class="s">service: {resource: "service"}</span>
      <span class="s">name:</span>
        <span class="s">matches: "^(.*)_requests"</span>
        <span class="s">as: "${1}_avg"</span>
      <span class="s">metricsQuery: '&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}'</span>
<span class="s">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">service.alpha.openshift.io/serving-cert-secret-name</span><span class="pi">:</span> <span class="s">prometheus-adapter-tls</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-adapter</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-adapter</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">prometheus-metric</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">https</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">443</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">6443</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus-adapter</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apiregistration.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">APIService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">v1beta1.custom.metrics.k8s.io</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-adapter</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">prometheus-metric</span>
  <span class="na">group</span><span class="pi">:</span> <span class="s">custom.metrics.k8s.io</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">v1beta1</span>
  <span class="na">insecureSkipTLSVerify</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">groupPriorityMinimum</span><span class="pi">:</span> <span class="m">100</span>
  <span class="na">versionPriority</span><span class="pi">:</span> <span class="m">100</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus-adapter</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-adapter</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">prometheus-metric</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus-adapter</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">prometheus-adapter</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-adapter</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">custom-metrics-apiserver</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-adapter</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">directxman12/k8s-prometheus-adapter-amd64</span>
        <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">--secure-port=6443</span>
        <span class="pi">-</span> <span class="s">--tls-cert-file=/var/run/serving-cert/tls.crt</span>
        <span class="pi">-</span> <span class="s">--tls-private-key-file=/var/run/serving-cert/tls.key</span>
        <span class="pi">-</span> <span class="s">--logtostderr=true</span>
        <span class="pi">-</span> <span class="s">--prometheus-url=http://prometheus-operated:9090/</span>
        <span class="pi">-</span> <span class="s">--metrics-relist-interval=1m</span>
        <span class="pi">-</span> <span class="s">--v=4</span>
        <span class="pi">-</span> <span class="s">--config=/etc/adapter/config.yaml</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">6443</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/run/serving-cert</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">volume-serving-cert</span>
          <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/adapter/</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">config</span>
          <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/tmp</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">tmp-vol</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">volume-serving-cert</span>
        <span class="na">secret</span><span class="pi">:</span>
          <span class="na">secretName</span><span class="pi">:</span> <span class="s">prometheus-adapter-tls</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config</span>
        <span class="na">configMap</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">adapter-config</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tmp-vol</span>
        <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<p>RBACì˜ ì •ì˜ëŠ” Adopterê°€ ë™ì‘í•˜ëŠ”ë° í•„ìš”í•œ <code class="language-plaintext highlighter-rouge">ServiceAccount</code>, <code class="language-plaintext highlighter-rouge">ClusterRole</code>, <code class="language-plaintext highlighter-rouge">RoleBinding</code>, <code class="language-plaintext highlighter-rouge">ClusterRoleBinding</code> ì„ ì‘ì„±í•©ë‹ˆë‹¤.</p>

<h4 id="prometheus-ìˆ˜ì§‘-í™•ì¸">Prometheus ìˆ˜ì§‘ í™•ì¸</h4>

<ul>
  <li>
    <p>Prometheus êµ¬ì„±ì´ ë°°í¬ëœ <code class="language-plaintext highlighter-rouge">prometheus-metric</code> í”„ë¡œì íŠ¸ì—ì„œ ìˆ˜í–‰</p>
  </li>
  <li>
    <p>ì¢Œì¸¡ Overview í´ë¦­ í›„ ëª©ë¡ì—ì„œ <code class="language-plaintext highlighter-rouge">prometheus-example</code>ì˜ route í´ë¦­í•˜ì—¬ Prometheus Console í™•ì¸</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Execute</code>ìš°ì¸¡ì˜ <code class="language-plaintext highlighter-rouge">-insert metric at cursor-</code> ëª©ë¡ì—ì„œ ì¶”ê°€ëœ <code class="language-plaintext highlighter-rouge">jboss_active_requests</code> í•­ëª© ì„ íƒ í›„ <code class="language-plaintext highlighter-rouge">Execute</code> í´ë¦­ í•˜ì—¬ ê°’ í™•ì¸</p>

    <p>| <strong>Element</strong>                                                  | Value |
| â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” | â€”â€“ |
| jboss_active_requests{instance=â€sample-eap.my-eap-project.svc:58080â€,job=â€jboss-eapâ€,namespace=â€my-eap-projectâ€,pod=â€sample-eapâ€,service=â€sample-eapâ€} | 0     |</p>
    <ul>
      <li>namespace, pod, serviceëŠ” <code class="language-plaintext highlighter-rouge">jmx_exporter_conf.yaml</code>ì—ì„œ ë¶€ì—¬ í•œ ê°’</li>
      <li>ê¸°ë³¸ jmx-exporterì˜ ê²½ìš° pod ì •ë³´ë¥¼ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ</li>
      <li>namespaceë¡œ ë©”íŠ¸ë¦­ì„ í™•ì¸</li>
    </ul>
  </li>
</ul>

<h2 id="test-automatic-scaling">Test automatic scaling</h2>

<p>Adopterê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ Metricì„ ê²€ìƒ‰í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ê³  ìˆëŠ”ì§€ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>

<ul>
  <li>
    <p>Adopterê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ Metric ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ë„ë¡ êµ¬ì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span> oc get <span class="nt">--raw</span> <span class="s2">"/apis/custom.metrics.k8s.io/v1beta1"</span> | jq <span class="nb">.</span>
<span class="o">{</span>
  <span class="s2">"kind"</span>: <span class="s2">"APIResourceList"</span>,
  <span class="s2">"apiVersion"</span>: <span class="s2">"v1"</span>,
  <span class="s2">"groupVersion"</span>: <span class="s2">"custom.metrics.k8s.io/v1beta1"</span>,
  <span class="s2">"resources"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"namespaces/jboss_active_avg"</span>,
      <span class="s2">"singularName"</span>: <span class="s2">""</span>,
      <span class="s2">"namespaced"</span>: <span class="nb">false</span>,
      <span class="s2">"kind"</span>: <span class="s2">"MetricValueList"</span>,
      <span class="s2">"verbs"</span>: <span class="o">[</span>
        <span class="s2">"get"</span>
      <span class="o">]</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"pods/jboss_active_avg"</span>,
      <span class="s2">"singularName"</span>: <span class="s2">""</span>,
      <span class="s2">"namespaced"</span>: <span class="nb">true</span>,
      <span class="s2">"kind"</span>: <span class="s2">"MetricValueList"</span>,
      <span class="s2">"verbs"</span>: <span class="o">[</span>
        <span class="s2">"get"</span>
      <span class="o">]</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"services/jboss_active_avg"</span>,
      <span class="s2">"singularName"</span>: <span class="s2">""</span>,
      <span class="s2">"namespaced"</span>: <span class="nb">true</span>,
      <span class="s2">"kind"</span>: <span class="s2">"MetricValueList"</span>,
      <span class="s2">"verbs"</span>: <span class="o">[</span>
        <span class="s2">"get"</span>
      <span class="o">]</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ì• í”Œë¦¬ì¼€ì´ì…˜ Metricì¸ <code class="language-plaintext highlighter-rouge">jboss_active_avg</code>ê°€ ê²€ìƒ‰ë˜ëŠ” ì§€ í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>oc get <span class="nt">--raw</span> <span class="s2">"/apis/custom.metrics.k8s.io/v1beta1/namespaces/my-eap-project/metrics/jboss_active_avg"</span> | jq <span class="nb">.</span>
<span class="o">{</span>
  <span class="s2">"kind"</span>: <span class="s2">"MetricValueList"</span>,
  <span class="s2">"apiVersion"</span>: <span class="s2">"custom.metrics.k8s.io/v1beta1"</span>,
  <span class="s2">"metadata"</span>: <span class="o">{</span>
    <span class="s2">"selfLink"</span>: <span class="s2">"/apis/custom.metrics.k8s.io/v1beta1/namespaces/my-eap-project/metrics/jboss_active_avg"</span>
  <span class="o">}</span>,
  <span class="s2">"items"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"describedObject"</span>: <span class="o">{</span>
        <span class="s2">"kind"</span>: <span class="s2">"Namespace"</span>,
        <span class="s2">"name"</span>: <span class="s2">"my-eap-project"</span>,
        <span class="s2">"apiVersion"</span>: <span class="s2">"/v1"</span>
      <span class="o">}</span>,
      <span class="s2">"metricName"</span>: <span class="s2">"jboss_active_avg"</span>,
      <span class="s2">"timestamp"</span>: <span class="s2">"2020-01-30T07:12:01Z"</span>,
      <span class="s2">"value"</span>: <span class="s2">"3"</span>,
      <span class="s2">"selector"</span>: null
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>ê²°ê³¼ ê°’ì€ JBoss ìƒì˜ Active Requestê°€ 3ê°œì„ì„ ì˜ë¯¸ í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>Horizontal Pod Autoscaler (HPA) ë¦¬ì†ŒìŠ¤ë¥¼ ì ìš©í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>oc apply <span class="nt">-f</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
kind: HorizontalPodAutoscaler
apiVersion: autoscaling/v2beta1
metadata:
  name: sample-eap
  namespace: my-eap-project
spec:
  scaleTargetRef:
    apiVersion: apps.openshift.io/v1
    kind: DeploymentConfig
    name: sample-eap
  minReplicas: 1
  maxReplicas: 5
  metrics:
  - type: Object
    object:
      target:
        kind: Namespace
        name: my-eap-project
      metricName: jboss_active_avg
      targetValue: 10
</span><span class="no">EOF
</span></code></pre></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">namespace</code>ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬í•˜ê¸° ë•Œë¬¸ì— <code class="language-plaintext highlighter-rouge">Object</code> í˜•íƒœì˜ metricsë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì ìš©ëœ HPAë¥¼ í™•ì¸í•˜ì—¬ ì ìš©ëœ JBoss EAPì— ìš”ì²­ì— ë”°ë¼ ê°’ì´ ë³€í™”í•˜ê³  Podì˜ ìˆ˜ê°€ ë³€í™”í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>watch oc describe hpa/sample-eap <span class="nt">-n</span> my-eap-project
Every 2.0s: oc describe hpa/sample-eap <span class="nt">-n</span> my-eap-pr...  Thu Jan 30 07:23:47 2020
  
Name:                                              sample-eap
Namespace:                                         my-eap-project
Labels:                                            &lt;none&gt;
Annotations:                                       kubectl.kubernetes.io/last-ap
plied-configuration<span class="o">={</span><span class="s2">"apiVersion"</span>:<span class="s2">"autoscaling/v2beta1"</span>,<span class="s2">"kind"</span>:<span class="s2">"HorizontalPodAut
oscaler"</span>,<span class="s2">"metadata"</span>:<span class="o">{</span><span class="s2">"annotations"</span>:<span class="o">{}</span>,<span class="s2">"name"</span>:<span class="s2">"sample-eap"</span>,<span class="s2">"namespace"</span>:<span class="s2">"my-eap-pr
oject"</span><span class="o">}</span>,<span class="s2">"sp...
CreationTimestamp:                                 Thu, 30 Jan 2020 07:18:17 +00
00
Reference:                                         DeploymentConfig/sample-eap
Metrics:                                           ( current / target )
  "</span>jboss_active_avg<span class="s2">" on Namespace/my-eap-project:  16 / 10
Min replicas:                                      1
Max replicas:                                      5
DeploymentConfig pods:                             1 current / 2 desired
Conditions:
  Type            Status  Reason              Message
  ----            ------  ------              -------
  AbleToScale     True    SucceededRescale    the HPA controller was able to upd
ate the target scale to 2
  ScalingActive   True    ValidMetricFound    the HPA was able to successfully c
alculate a replica count from Namespace metric jboss_active_avg
  ScalingLimited  False   DesiredWithinRange  the desired count is within the ac
ceptable range
Events:
  Type    Reason             Age   From                       Message
  ----    ------             ----  ----                       -------
  Normal  SuccessfulRescale  17s   horizontal-pod-autoscaler  New size: 2; reaso
n: Namespace metric jboss_active_avg above target
</span></code></pre></div>    </div>
  </li>
</ul>

<h2 id="appendix">Appendix</h2>

<h3 id="1-ì°¸ê³ -ìë£Œ">1. ì°¸ê³  ìë£Œ</h3>

<ul>
  <li>https://medium.com/ibm-cloud/autoscaling-applications-on-openshift-container-platform-3-11-with-custom-metrics-6e9c14474de3</li>
  <li>Sample app (github) : https://github.com/Great-Stone/webapp</li>
  <li>s2i-wildfly : https://github.com/openshift-s2i/s2i-wildfly</li>
  <li>rhpam prometheus ì°¸ê³  : https://github.com/DuncanDoyle/rhpam-prometheus-grafana-ocp</li>
  <li>jmx exporter : https://github.com/prometheus/jmx_exporter</li>
  <li>jmx exporter for JBoss/Wildfly : https://lazarbulic.com/blog/2018/05/25/prometheus-jmx_exporter-for-jboss-wildfly/</li>
  <li>Prometheus Query : https://prometheus.io/docs/prometheus/latest/querying/basics/</li>
  <li>OpenShift k8s-prometheus-adapter (github) : https://github.com/openshift/k8s-prometheus-adapter</li>
  <li>Horizontal Pod Autoscaler : https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/</li>
  <li>Exposing custom application metrics for autoscaling OCP 4.1~ : https://docs.openshift.com/container-platform/4.3/monitoring/exposing-custom-application-metrics-for-autoscaling.html</li>
  <li>Installing the Operator Framework OCP 3.11 : https://docs.openshift.com/container-platform/3.11/install_config/installing-operator-framework.html</li>
</ul>

<h3 id="2-memory-based-hpa">2. Memory based HPA</h3>

<blockquote>
  <p>ë‹¤ìŒì˜ ì •ë³´ê°€ ë„ì›€ì´ ë©ë‹ˆë‹¤. :</p>

  <ul>
    <li>https://blog.openshift.com/kubernetes-1-8-now-custom-metrics/</li>
    <li>https://bugzilla.redhat.com/show_bug.cgi?id=1533790</li>
  </ul>
</blockquote>

<p>v2beta1 apië¥¼ ì ìš©í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>
    <p>master ë…¸ë“œì˜ <code class="language-plaintext highlighter-rouge">master-config.yaml</code>ìˆ˜ì •</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vi /etc/origin/master/master-config.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">apiServerArguments</code>ì— <code class="language-plaintext highlighter-rouge">runtime-config</code> í•­ëª©ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">apis/autoscaling/v2beta1=true</code> ì¶”ê°€</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kubernetesMasterConfig</span><span class="pi">:</span>
<span class="nn">...</span>
  <span class="na">apiServerArguments</span><span class="pi">:</span>
<span class="err">	</span><span class="s">...</span>
    <span class="s">runtime-config</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">apis/autoscaling/v2beta1=true</span>
  <span class="na">controllerArguments</span><span class="pi">:</span>
<span class="nn">...</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>master êµ¬ì„±ìš”ì†Œ ì¬ì‹œì‘</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>master-restart api
<span class="nv">$ </span>master-restart controllers
<span class="nv">$ </span>systemctl restart atomic-openshift-node.service
</code></pre></div>    </div>
  </li>
  <li>
    <p>api ì‘ë‹µ í™•ì¸</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>oc get <span class="nt">--raw</span> /apis/autoscaling/v2beta1
<span class="o">{</span><span class="s2">"kind"</span>:<span class="s2">"APIResourceList"</span>,<span class="s2">"apiVersion"</span>:<span class="s2">"v1"</span>,<span class="s2">"groupVersion"</span>:<span class="s2">"autoscaling/v2beta1"</span>,<span class="s2">"resources"</span>:[<span class="o">{</span><span class="s2">"name"</span>:<span class="s2">"horizontalpodautoscalers"</span>,<span class="s2">"singularName"</span>:<span class="s2">""</span>,<span class="s2">"namespaced"</span>:true,<span class="s2">"kind"</span>:<span class="s2">"HorizontalPodAutoscaler"</span>,<span class="s2">"verbs"</span>:[<span class="s2">"create"</span>,<span class="s2">"delete"</span>,<span class="s2">"deletecollection"</span>,<span class="s2">"get"</span>,<span class="s2">"list"</span>,<span class="s2">"patch"</span>,<span class="s2">"update"</span>,<span class="s2">"watch"</span><span class="o">]</span>,<span class="s2">"shortNames"</span>:[<span class="s2">"hpa"</span><span class="o">]</span>,<span class="s2">"categories"</span>:[<span class="s2">"all"</span><span class="o">]}</span>,<span class="o">{</span><span class="s2">"name"</span>:<span class="s2">"horizontalpodautoscalers/status"</span>,<span class="s2">"singularName"</span>:<span class="s2">""</span>,<span class="s2">"namespaced"</span>:true,<span class="s2">"kind"</span>:<span class="s2">"HorizontalPodAutoscaler"</span>,<span class="s2">"verbs"</span>:[<span class="s2">"get"</span>,<span class="s2">"patch"</span>,<span class="s2">"update"</span><span class="o">]}]}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>HPA ì ìš© :
ì˜ˆë¥¼ë“¤ì–´ <code class="language-plaintext highlighter-rouge">mnist-app</code> ì´ë¼ê³  í•˜ëŠ” <code class="language-plaintext highlighter-rouge">DeploymentConfig </code>ë¥¼ íƒ€ê²Ÿìœ¼ë¡œ í•¨</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">autoscaling/v2beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">HorizontalPodAutoscaler</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mnist-app</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">my-namespace</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">maxReplicas</span><span class="pi">:</span> <span class="m">10</span>
  <span class="na">minReplicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">scaleTargetRef</span><span class="pi">:</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps.openshift.io/v1</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">DeploymentConfig</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">mnist-app</span>
  <span class="na">metrics</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Resource</span>
    <span class="na">resource</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">memory</span>
      <span class="na">targetAverageUtilization</span><span class="pi">:</span> <span class="m">10</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Resource</span>
    <span class="na">resource</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">memory</span>
      <span class="na">targetAverageValue</span><span class="pi">:</span> <span class="s">1G</span>
</code></pre></div>    </div>

    <ul>
      <li>targetAverageUtilization : Pod ë“¤ì˜ ê°€ìš©í•œ Memoryë¥¼ 100ìœ¼ë¡œ ì‚°ì •í•˜ì—¬ ê·¸ì¤‘ ì‚¬ìš©ëŸ‰ì„ ê¸°ì¤€</li>
      <li>targetAverageValue : Pod ë“¤ì˜ í‰ê·  ì‚¬ìš©ëŸ‰ì„ ê¸°ì¤€</li>
    </ul>
  </li>
  <li>
    <p>https://docs.openshift.com/container-platform/4.1/monitoring/exposing-custom-application-metrics-for-autoscaling.html)</p>
  </li>
</ul>

<h3 id="3-registry-account">3. Registry account</h3>

<p>Red Hat Container Image Registryì— ì ‘ì†í•˜ê¸° ìœ„í•œ ì „ìš© ê³„ì •ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<ul>
  <li>https://registry.redhat.io ì— ì ‘ì†í•˜ì—¬ ë¡œê·¸ì¸</li>
  <li>ìš°ì¸¡ ìƒë‹¨ì˜ <code class="language-plaintext highlighter-rouge">Service Accounts</code>ë¥¼ í´ë¦­</li>
  <li><code class="language-plaintext highlighter-rouge">New Service Account</code> ë²„íŠ¼ì„ í´ë¦­</li>
  <li>Create a New Registry Service Account
    <ul>
      <li>Name : â€œA-z 0-9 .-_â€ ì¡°ê±´ì— ë§ëŠ” ì´ë¦„ì„ ì„¤ì • (e.g. registry)</li>
      <li>Description : í•´ë‹¹ ê³„ì • ì •ë³´ì— ëŒ€í•œ ì„¤ëª…ì„ ê¸°ì… (e.g. for image registry login)</li>
      <li><code class="language-plaintext highlighter-rouge">CREATE</code> ë²„íŠ¼ í´ë¦­</li>
    </ul>
  </li>
  <li>ìƒì„±ëœ Token Information í™•ì¸
    <ul>
      <li><code class="language-plaintext highlighter-rouge">Token Information</code> íƒ­ì˜ ì •ë³´ë¥¼ í™•ì¸</li>
      <li>
        <table>
          <tbody>
            <tr>
              <td>Username is **00000000</td>
              <td>registry** andâ€¦ ì„¤ëª…ì˜ <strong>ìˆ«ì+íŒŒì´í”„+ì´ë¦„</strong> í˜•íƒœê°€ Username</td>
            </tr>
          </tbody>
        </table>
      </li>
      <li>ì•„ë˜ Token ê°’(ë§¤ìš° ê¸´)ì´ Password ë¡œ ë™ì‘</li>
    </ul>
  </li>
</ul>

<p>ìƒì„±í•œ Tokenìœ¼ë¡œ ë³¸ë˜ì˜ ê³„ì • ì ‘ì† ì •ë³´ë¥¼ ë…¸ì¶œ í•˜ì§€ ì•Šê³  Red Hat Container Image Registryì— ì ‘ì†í•  ìˆ˜ ìˆëŠ” ì ‘ì† ì •ë³´ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h3 id="4-openshiftì—-ë¦¬ì†ŒìŠ¤-ë°°í¬">4. OpenShiftì— ë¦¬ì†ŒìŠ¤ ë°°í¬</h3>

<p>OpenShiftì— ë¦¬ì†ŒìŠ¤ë¥¼ ë°°í¬í•˜ëŠ” ë°©ë²•ì€ <code class="language-plaintext highlighter-rouge">oc</code> CLIë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ê³¼ Application Consoleì„ í™œìš©í•˜ëŠ” ë‘ê°€ì§€ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.</p>

<p>ë‹¤ìŒê³¼ ê°™ì€ <code class="language-plaintext highlighter-rouge">prometheus-operator</code>ê´€ë ¨ ë¦¬ì†ŒìŠ¤ ì„¤ì •ì´ ìˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">operators.coreos.com/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Subscription</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">generateName</span><span class="pi">:</span> <span class="s">prometheus-</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">custom-metric</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">source</span><span class="pi">:</span> <span class="s">rh-operators</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
  <span class="na">startingCSV</span><span class="pi">:</span> <span class="s">prometheusoperator.0.22.2</span>
  <span class="na">channel</span><span class="pi">:</span> <span class="s">preview</span>
</code></pre></div></div>

<p>yamlë¡œ ì‘ì„±ëœ ë¦¬ì†ŒìŠ¤ ì„¤ì • íŒŒì¼ì„ ì ìš©í•˜ê¸°ìœ„í•´ ë‹¤ìŒ ë‘ê°€ì§€ í˜•íƒœë¥¼ í™œìš©í•©ë‹ˆë‹¤.</p>

<h4 id="1-cli-í™œìš©">1) CLI í™œìš©</h4>

<p><code class="language-plaintext highlighter-rouge">oc</code> ë¡œê·¸ì¸ ìƒíƒœì—ì„œ yamlë¡œ ì‘ì„±ëœ ë¦¬ì†ŒìŠ¤ ì„¤ì •ì„ íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ <code class="language-plaintext highlighter-rouge">prometheus-operator.yaml</code> ì¸ ê²½ìš° ë‹¤ìŒê³¼ ê°™ì´ ì ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>oc apply <span class="nt">-f</span> prometheus-operator.yaml
</code></pre></div></div>

<p>ë˜ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì¸ë¼ì¸ìœ¼ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ $ </span>oc create <span class="nt">-f</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  generateName: prometheus-
  namespace: custom-metric
spec:
  source: rh-operators
  name: prometheus
  startingCSV: prometheusoperator.0.22.2
  channel: preview
</span><span class="no">EOF
</span></code></pre></div></div>

<h4 id="2-application-console-í™œìš©">2) Application Console í™œìš©</h4>

<p>OpenShift Application Console ì— ì ‘ì† í•©ë‹ˆë‹¤. ì ìš©í•  í”„ë¡œì íŠ¸ë¥¼ í´ë¦­í•˜ê³  <code class="language-plaintext highlighter-rouge">Overview</code> í™”ë©´ì˜ ìš°ì¸¡ ìƒë‹¨ì— <code class="language-plaintext highlighter-rouge">Add to Project</code>ë¥¼ í´ë¦­í•©ë‹ˆë‹¤.
<code class="language-plaintext highlighter-rouge">Import YAML/JSON</code>ì„ í´ë¦­í•˜ì—¬ ë¦¬ì†ŒìŠ¤ ì„¤ì •ì„ ì…ë ¥ë°›ëŠ” ì°½ì— ì•ì„œì˜ ì˜ˆë¡œ ì‘ì„±ëœ ì„¤ì •ì„ ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤. ë˜ëŠ” íŒŒì¼ë¡œ ì €ì¥ëœ íŒŒì¼ì„ ì„ íƒí•˜ì—¬ ì—…ë¡œë“œ/ì ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">Create</code> ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê²°ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
:ET